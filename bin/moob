#!/usr/bin/env ruby

require 'optparse'
require 'moob'

options = {
    :action => :jnlp,
    :type => :auto,
    :machines => [],
    :password => ENV['password']
}

OptionParser.new do |opts|
    opts.on '-t', '--type t',
    'LOM type, \'auto\' for autodetection, \'list\' to list',
    'Defaults to auto' do |t|
        if t == 'list'
            Moob::TYPES.each do |sym, klass|
                puts "#{sym} (#{klass.name})"
            end
            exit 0
        else
            options[:type] = t.to_sym
        end
    end

    opts.on '-a', '--action t',
    'Action to perform, \'list\' to list',
    'Defaults to jnlp' do |a|
        if a == 'list'
            Moob::TYPES.each do |sym, klass|
                if klass.actions
                    puts "#{sym}: " + klass.actions.to_a.join(',')
                else
                    puts "#{sym}: no actions"
                end
            end
            exit 0
        else
            options[:action] = a.to_sym
        end
    end

    opts.on '-u', '--username u',
    'LOM username',
    'Defaults to the model\'s default if known' do |u|
            options[:username] = u
    end

    opts.on '-p', '--password p',
    'LOM password',
    'Defaults to the model\'s default if known',
    'Use the environment variable PASSWORD instead!' do |p|
        options[:password] = p
    end

    opts.on '-m', '--machines a,b,c', Array,
    'Comma-separated list of LOM hostnames' do |m|
            options[:machines] = m
    end

    opts.on '-v', '--verbose' do
        $VERBOSE = true
    end
end.parse!

if options[:machines].empty?
    $stderr.puts 'No LOMs selected.'
    exit 1
end

begin
    options[:machines].each do |h|
        case options[:action]
        when :jnlp
            Moob.start_jnlp options[:type], h, options
        end
    end
    puts 'There might be a delay before Java Web Start shows up...' if options[:action] == :jnlp

rescue Exception => e
    $stderr.puts "\033[31mFailure (#{e.class}): #{e}\033[0m\n\n" \
        "Backtrace to provide in any support request:\033[2;34m"
    $stderr.puts e.backtrace
    $stderr.puts "\033[0m"
    exit 1
end
